syntax = "proto3";

package tzero.v1.payment;

import "tzero/v1/common/common.proto";
import "tzero/v1/common/payment_method.proto";
import "tzero/v1/common/payment_receipt.proto";
import "ivms101/v1/ivms/ivms101.proto";
import "google/protobuf/timestamp.proto";
import "buf/validate/validate.proto";

/**
 * This service is used by provider to interact with the Network, e.g. push quotes and initiate payments.
 *
 * All methods of this service are idempotent, meaning they are safe to retry and multiple calls with the same parameters will have no additional effect.
 */
service NetworkService {

  /**
    * Used by the provider to publish pay-in and pay-out quotes (FX rates) into the network.
    * These quotes include tiered pricing bands and an expiration timestamp.
   */
  rpc UpdateQuote(UpdateQuoteRequest) returns (UpdateQuoteResponse)  {
    option idempotency_level = IDEMPOTENT;
  };

  /**
   * Request the best available quote for a payout in a specific currency, for a given amount.
   * If the payout quote exists, but the credit limit is exceeded, this quote will not be considered.
   */
  rpc GetQuote(GetQuoteRequest) returns (GetQuoteResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  };

  /**
    * Submit a request to create a new payment for the specified pay-out currency.
    * QuoteId is the optional parameter.
    * If the quoteID is specified, it must be a valid quoteId that was previously returned by the GetPayoutQuote method.
    * If the quoteId is not specified, the network will try to find a suitable quote for the payout currency and amount,
    * same way as GetPayoutQuote rpc.
   */
  rpc CreatePayment(CreatePaymentRequest) returns (CreatePaymentResponse) {
    option idempotency_level = IDEMPOTENT;
  };

  /**
   * Inform the network that a payout has been completed. This endpoint is called by the payout
   * provider, specifying the payment ID and payout ID, which was provided when the payout request was made to this provider.
   */
  rpc ConfirmPayout(ConfirmPayoutRequest) returns (ConfirmPayoutResponse)  {
    option idempotency_level = IDEMPOTENT;
  };


  /**
   * Pay-out provider reports the result of manual AML check.
   * This endpoint is called after the manual AML check is completed. The network will find the new best quotes for the
   * payment and will return the updated settlement/payout amount along with the updated quotes in the response.
   */
  rpc CompleteManualAmlCheck(CompleteManualAmlCheckRequest) returns (CompleteManualAmlCheckResponse) {
    option idempotency_level = IDEMPOTENT;
  };
}

/*
 * Base currency is always USD, so the quotes are always in USD/currency format.
 */
message UpdateQuoteRequest {
  /**
   * Zero or more quotes for pay-out operations, each quote must have a unique currency, and one or more bands, with the
   * unique client_quote_id for each band.
   */
  repeated Quote pay_out = 10;
  /**
   * Zero or more quotes for pay-in operations, each quote must have a unique currency, and one or more bands, with the
   * unique client_quote_id for each band.
   */
  repeated Quote pay_in = 20;

  message Quote {
    string currency = 10 [(buf.validate.field).string = {
      len: 3,
      pattern: "^[A-Z]{3}$"
    }]; // BRL, EUR, GBP, etc. (ISO 4217 currency code)

    QuoteType quote_type = 20 [(buf.validate.field).required = true];
    // Payment method must be specified
    tzero.v1.common.PaymentMethodType payment_method = 25 [(buf.validate.field).required = true];

    repeated Band bands = 30 [(buf.validate.field).repeated = {
      min_items: 1
    }]; // list of bands for this quote

    google.protobuf.Timestamp expiration = 60 [(buf.validate.field).timestamp.gt_now = true]; // expiration time of the quote

    google.protobuf.Timestamp timestamp = 70 [(buf.validate.field).required = true]; // timestamp quote was created

    message Band {

      string client_quote_id = 10 [(buf.validate.field).string = {
        min_len: 1,
        max_len: 64
      }]; // unique client generated id for this band

      tzero.v1.common.Decimal max_amount = 40 [(buf.validate.field).required = true]; // max amount of USD this quote is applicable for. Please look into documentation for valid amounts.

      tzero.v1.common.Decimal rate = 50 [(buf.validate.field).required = true]; // USD/currency rate
    }
  }
}

message UpdateQuoteResponse {}

message GetQuoteRequest {
  PaymentAmount amount = 20 [(buf.validate.field).required = true]; // payment amount - must be either pay-out amount or settlement amount

  string pay_out_currency = 40 [(buf.validate.field).string = {len: 3, pattern: "^[A-Z]{3}$"}]; // ISO 4217 currency code, e.g. EUR, GBP, etc. in which the payout should be made

  tzero.v1.common.PaymentMethodType pay_out_method = 50 [(buf.validate.field).required = true]; // payment method to use for the payout, e.g. bank transfer, card, etc.

  QuoteType quote_type = 60 [(buf.validate.field).required = true]; // type of the quote, e.g. real-time
}

message GetQuoteResponse {

  oneof result {
    option (buf.validate.oneof).required = true;
    /**
     * Success response - the network found a suitable quote for the provided parameters and with available credit or pre-settlement option.
     * The returned quoteId can be used later to call the create payment endpoint.
     */
    Success success = 20;
    /**
     * Failure response - means the quote was not found for the specified parameters, or provider limits
     * would exceed by processing the payment amount with the specified amount.
     */
    Failure failure = 30;
  };

  message Success {
    tzero.v1.common.Decimal rate = 10 [(buf.validate.field).required = true]; // pay-out quote rate in settlement_currency/pay_out_currency, i.e. USD/pay_out_currency
    google.protobuf.Timestamp expiration = 20 [(buf.validate.field).timestamp.gt_now = true]; // expiration time of the payout quote
    QuoteId quote_id = 30 [(buf.validate.field).required = true]; // id of the payout quote

    tzero.v1.common.Decimal pay_out_amount = 40 [(buf.validate.field).required = true]; // pay-out amount in pay-out currency if the quote from response is used
    tzero.v1.common.Decimal settlement_amount = 50 [(buf.validate.field).required = true]; // settlement amount in settlement currency if the quote from response is used
  }

  message Failure {
    Reason reason = 10;

    enum Reason {
      REASON_UNSPECIFIED = 0;
      REASON_QUOTE_NOT_FOUND = 10; // No matching quote par for the specified payout currency found or provider limits would exceed by processing this payment
    }
  }
}

message CreatePaymentRequest{
  string payment_client_id = 10 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 64
  }]; // unique client generated id for this payment

  PaymentAmount amount = 30 [(buf.validate.field).required = true]; // payment amount - should be either pay-out amount or settlement amount

  string currency = 40 [(buf.validate.field).string = {len: 3, pattern: "^[A-Z]{3}$"}]; // pay-out currency
  tzero.v1.common.PaymentDetails payment_details = 50 [(buf.validate.field).required = true]; // pay-out payment details
  optional QuoteId quote_id = 60; // if specified, must be a valid quoteId that was previously returned by the GetPayoutQuote method otherwise last available quote will be used

  optional TravelRuleData travel_rule_data = 100; // travel rule data

  message TravelRuleData {
    /**
     * the natural or legal person that requests payment with originating provider
     */
    repeated ivms101.Person originator = 10 [(buf.validate.field).repeated.min_items = 1];

    /**
     * the natural or legal person or legal arrangement who is identified
     * by the originator as the receiver of the requested payment.
     */
    repeated ivms101.Person beneficiary = 20 [(buf.validate.field).repeated.min_items = 1];
  }
}

message QuoteId {
  int64 quote_id = 30 [(buf.validate.field).int64.gt = 0]; // unique identifier of the quote within the specified provider

  int32 provider_id = 40 [(buf.validate.field).int32.gt = 0]; // provider id of the quote
}

message CreatePaymentResponse {
  string payment_client_id = 10 [(buf.validate.field).string.min_len = 1]; // client generated id supplied in the request

  oneof result {
    option (buf.validate.oneof).required = true;
    /**
     * Accepted response - means the payment was accepted, but the payout is not yet completed. This means, the network found
     * a suitable quote for the payout currency and amount, and instructed the payout provider to process the payout.
     */
    Accepted accepted = 20;

    /**
     * Settlement required response - indicates that the payment requires settlement before payout completion.
     */
    SettlementRequired settlement_required = 35; //

    /**
     * Failure response - means the payment was not accepted, e.g. the network could not find a suitable quote for the
     * payout currency and amount, or the credit limit is exceeded for the available quotes.
     */
    Failure failure = 30;
  };

  message Accepted {
    uint64 payment_id = 10 [(buf.validate.field).uint64.gt = 0]; // payment ID assigned by the network
    tzero.v1.common.Decimal settlement_amount = 30 [(buf.validate.field).required = true];
    tzero.v1.common.Decimal payout_amount = 40 [(buf.validate.field).required = true];
    uint32 payout_provider_id = 50 [(buf.validate.field).uint32.gt = 0]; // payout provider id with the best quote selected for this payment
  }

  message SettlementRequired {
    uint64 payment_id = 10 [(buf.validate.field).uint64.gt = 0]; // payment ID assigned by the network
    tzero.v1.common.Decimal settlement_amount = 20 [(buf.validate.field).required = true];
    uint32 payout_provider_id = 30 [(buf.validate.field).uint32.gt = 0]; // payout provider id with the best quote selected for this payment
  }

  message Failure {
    Reason reason = 10;

    enum Reason {
      REASON_UNSPECIFIED = 0;
      REASON_QUOTE_NOT_FOUND = 10; // No matching quote for the specified payout currency found or provider limits would exceed by processing this payment
      REASON_CREDIT_OR_PREDEPOSIT_REQUIRED = 20; // Payments with amount in pay out currency require available credit or pre-deposit
    }
  }
}

message ConfirmPayoutRequest{
  uint64 payment_id = 10 [(buf.validate.field).uint64.gt = 0]; // payment id assigned by the network, this is the same payment id that was provided in the PayoutRequest

  uint64 payout_id = 20 [(buf.validate.field).uint64.gt = 0]; // payout id assigned by the payout provider, this is the same payout id that was provided in the PayoutRequest

  /**
  * Payment receipt might contain metadata about payment recognizable by pay-in provider.
  */
  optional tzero.v1.common.PaymentReceipt receipt = 30;
}

message ConfirmPayoutResponse{}

message CompleteManualAmlCheckRequest {
  uint64 payment_id = 10 [(buf.validate.field).uint64.gt = 0];

  oneof result {
    option (buf.validate.oneof).required = true;
    Approved approved = 30;
    Rejected rejected = 40;
  }

  message Approved {}

  message Rejected {
    string reason = 10 [(buf.validate.field).string.max_len = 1024];
  }
}

message CompleteManualAmlCheckResponse {
  oneof result {
    option (buf.validate.oneof).required = true;
    Approved approved = 30;
    Rejected rejected = 40;
  }

  message Approved {
    /**
     * amount in currency of the payout
     * This is the updated amount that should be paid out to the recipient.
     */
    tzero.v1.common.Decimal pay_out_amount = 10 [(buf.validate.field).required = true];

    /*

     */
    tzero.v1.common.Decimal settlement_amount = 20 [(buf.validate.field).required = true];

    /*
     unique identifier of the pay-out quote
     */
    int64 pay_out_quote_id = 30 [(buf.validate.field).int64.gt = 0];
  }

  // Rejected means that the updated quotes were rejected by pay-in provider, and the payout provider should not proceed
  // with the payout.
  message Rejected {}
}


// Payment amount could be specified either as settlement amount and then converted to corresponding amount of pay-out amount
// or as pay-out amount, so that the settlement amount is calculated accordingly
message PaymentAmount {
  oneof amount {
    option (buf.validate.oneof).required = true;
    tzero.v1.common.Decimal pay_out_amount = 20; // Amount in the pay-out currency
    tzero.v1.common.Decimal settlement_amount = 30; // Settlement amount in the settlement currency
  }
}

enum QuoteType {
  QUOTE_TYPE_UNSPECIFIED = 0;
  QUOTE_TYPE_REALTIME = 1; // real-time quote must be valid at least for 30 seconds (TBD)
}
