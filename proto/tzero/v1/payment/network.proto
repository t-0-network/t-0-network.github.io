syntax = "proto3";

package tzero.v1.payment;

import "tzero/v1/common/common.proto";
import "tzero/v1/common/payment_method.proto";
import "tzero/v1/common/payment_receipt.proto";
import "ivms101/v1/ivms/ivms101.proto";
import "google/protobuf/timestamp.proto";
import "buf/validate/validate.proto";

/**
 * This service is used by provider to interact with the Network, e.g. push quotes and initiate payments.
 *
 * All methods of this service are idempotent, meaning they are safe to retry and multiple calls with the same parameters will have no additional effect.
 */
service NetworkService {

  /**
    * Used by the provider to publish pay-in and pay-out quotes (FX rates) into the network.
    * These quotes include tiered pricing bands and an expiration timestamp.
   */
  rpc UpdateQuote(UpdateQuoteRequest) returns (UpdateQuoteResponse)  {
    option idempotency_level = IDEMPOTENT;
  };

  /**
   * Request the best available quote for a payout in a specific currency, for a given amount.
   * If the payout quote exists, but the credit limit is exceeded, this quote will not be considered.
   */
  rpc GetQuote(GetQuoteRequest) returns (GetQuoteResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  };

  /**
    * Submit a request to create a new payment. PayIn currency and QuoteId are the optional parameters.
    * If the payIn currency is not specified, the network will use USD as the default payIn currency, and considering
    * the amount in USD.
    * If specified, it must be a valid currency code - in this case the network will try to find the payIn quote for the
    * specified currency and considering the band from the provider initiated this request. So this is only possible, if
    * this provider already submitted the payIn quote for the specified currency using UpdateQuote rpc.
    * If the quoteID is specified, it must be a valid quoteId that was previously returned by the GetPayoutQuote method.
    * If the quoteId is not specified, the network will try to find a suitable quote for the payout currency and amount,
    * same way as GetPayoutQuote rpc.
   */
  rpc CreatePayment(CreatePaymentRequest) returns (CreatePaymentResponse) {
    option idempotency_level = IDEMPOTENT;
  };

  /**
   * Inform the network that a payout has been completed. This endpoint is called by the payout
   * provider, specifying the payment ID and payout ID, which was provided when the payout request was made to this provider.
   */
  rpc ConfirmPayout(ConfirmPayoutRequest) returns (ConfirmPayoutResponse)  {
    option idempotency_level = IDEMPOTENT;
  };
}

/*
 * Base currency is always USD, so the quotes are always in USD/currency format.
 */
message UpdateQuoteRequest {
  /**
   * Zero or more quotes for pay-out operations, each quote must have a unique currency, and one or more bands, with the
   * unique client_quote_id for each band.
   */
  repeated Quote pay_out = 10;
  /**
   * Zero or more quotes for pay-in operations, each quote must have a unique currency, and one or more bands, with the
   * unique client_quote_id for each band.
   */
  repeated Quote pay_in = 20;

  message Quote {
    string currency = 10 [(buf.validate.field).string = {
      len: 3,
      pattern: "^[A-Z]{3}$"
    }]; // BRL, EUR, GBP, etc. (ISO 4217 currency code)

    QuoteType quote_type = 20 [(buf.validate.field).required = true];
    // Payment method must be specified
    tzero.v1.common.PaymentMethodType payment_method = 25 [(buf.validate.field).required = true];

    repeated Band bands = 30 [(buf.validate.field).repeated = {
      min_items: 1
    }]; // list of bands for this quote

    google.protobuf.Timestamp expiration = 60 [(buf.validate.field).timestamp.gt_now = true]; // expiration time of the quote

    google.protobuf.Timestamp timestamp = 70 [(buf.validate.field).required = true]; // timestamp quote was created

    message Band {

      string client_quote_id = 10 [(buf.validate.field).string = {
        min_len: 1,
        max_len: 64
      }]; // unique client generated id for this band

      tzero.v1.common.Decimal max_amount = 40 [(buf.validate.field).required = true]; // max amount of USD this quote is applicable for. Please look into documentation for valid amounts.

      tzero.v1.common.Decimal rate = 50 [(buf.validate.field).required = true]; // USD/currency rate
    }
  }
}

message UpdateQuoteResponse {}

message GetQuoteRequest {
  string pay_in_currency = 10 [(buf.validate.field).string = {len: 3, pattern: "^[A-Z]{3}$"}]; // ISO 4217 currency code, e.g. EUR, GBP, etc. in which the payout should be made
  PaymentAmount amount = 20 [(buf.validate.field).required = true]; // amount
  tzero.v1.common.PaymentMethodType pay_in_method = 30 [(buf.validate.field).required = true]; // payment method to use for the payout, e.g. bank transfer, card, etc.

  string pay_out_currency = 40 [(buf.validate.field).string = {len: 3, pattern: "^[A-Z]{3}$"}]; // ISO 4217 currency code, e.g. EUR, GBP, etc. in which the payout should be made
  tzero.v1.common.PaymentMethodType pay_out_method = 50 [(buf.validate.field).required = true]; // payment method to use for the payout, e.g. bank transfer, card, etc.

  QuoteType quote_type = 60 [(buf.validate.field).required = true]; // type of the quote, e.g. real-time or guaranteed
}

message GetQuoteResponse {
  tzero.v1.common.Decimal rate = 10 [(buf.validate.field).required = true]; // rate in USD/currency, e.g. 1.2345 for 1 USD = 1.2345 EUR

  google.protobuf.Timestamp expiration = 20 [(buf.validate.field).timestamp.gt_now = true]; // expiration time of the quote

  QuoteId quote_id = 30 [(buf.validate.field).required = true]; //
}

message CreatePaymentRequest{
  string payment_client_id = 10 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 64
  }]; // unique client generated id for this payment

  PaymentAmount amount = 30 [(buf.validate.field).required = true];
  PayIn pay_in = 40 [(buf.validate.field).required = true];
  PayOut pay_out = 45 [(buf.validate.field).required = true];

  // Provider must submit quotes to the network for the specified pay-in currency and payment method
  message PayIn {
    string currency = 10 [(buf.validate.field).string = {len: 3, pattern: "^[A-Z]{3}$"}];
    tzero.v1.common.PaymentMethodType payment_method = 20 [(buf.validate.field).required = true];
  }

  message PayOut {
    string currency = 10 [(buf.validate.field).string = {len: 3, pattern: "^[A-Z]{3}$"}];
    tzero.v1.common.PaymentMethod payment_method = 20 [(buf.validate.field).required = true];
    optional QuoteId quote_id = 100; // if specified, must be a valid quoteId that was previously returned by the GetPayoutQuote method otherwise last available quote will be used
  }

  optional TravelRuleData travel_rule_data = 100;

  message TravelRuleData {
    // the natural or legal person that requests payment with originating provider
    repeated ivms101.Person originator = 10 [(buf.validate.field).repeated.min_items = 1];

    // the natural or legal person or legal arrangement who is identified
    // by the originator as the receiver of the requested payment.
    repeated ivms101.Person beneficiary = 20 [(buf.validate.field).repeated.min_items = 1];
  }
}

message QuoteId {
  int64 quote_id = 30 [(buf.validate.field).int64.gt = 0]; // unique identifier of the quote within the specified provider

  int32 provider_id = 40 [(buf.validate.field).int32.gt = 0]; // provider id of the quote
}

message CreatePaymentResponse {
  string payment_client_id = 10 [(buf.validate.field).string.min_len = 1]; // client generated id supplied in the request

  oneof result {
    option (buf.validate.oneof).required = true;
    /**
     * Success response - means the payment was accepted, but the payout is not yet completed. This means, the network found
     * a suitable quote for the payout currency and amount, and instructed the payout provider to process the payout.
     */
    Success success = 20;
    /**
     * Failure response - means the payment was not accepted, e.g. the network could not find a suitable quote for the
     * payout currency and amount, or the credit limit is exceeded for the available quotes.
     */
    Failure failure = 30;
  };

  message Success {
    uint64 payment_id = 10 [(buf.validate.field).uint64.gt = 0]; // payment id assigned by the network
    tzero.v1.common.Decimal pay_in_amount = 20 [(buf.validate.field).required = true];
    tzero.v1.common.Decimal settlement_amount = 30 [(buf.validate.field).required = true];
  }

  message Failure {
    enum Reason {
      REASON_UNSPECIFIED = 0;

    }
  }
}

message ConfirmPayoutRequest{
  uint64 payment_id = 10 [(buf.validate.field).uint64.gt = 0]; // payment id assigned by the network, this is the same payment id that was provided in the PayoutRequest

  uint64 payout_id = 20 [(buf.validate.field).uint64.gt = 0]; // payout id assigned by the payout provider, this is the same payout id that was provided in the PayoutRequest

  /**
  * Payment receipt might contain metadata about payment recognizable by pay-in provider.
  */
  tzero.v1.common.PaymentReceipt receipt = 30;
}

message ConfirmPayoutResponse{}

// Payment amount could be specified eiter as pay-in amount and then converted to corresponding amount of pay-out amount
// or as pay-out amount, so that pay-in and settlement amounts are calculated accordingly
message PaymentAmount {
  oneof amount {
    option (buf.validate.oneof).required = true;
    tzero.v1.common.Decimal pay_in_amount = 10; // Amount in the pay-in currency
    tzero.v1.common.Decimal pay_out_amount = 20; // Amount in the pay-out currency
  }
}

enum QuoteType {
  QUOTE_TYPE_UNSPECIFIED = 0;
  QUOTE_TYPE_REALTIME = 1; // real-time quote must be valid at least for 30 seconds (TBD)
  //QUOTE_TYPE_GUARANTEED = 2; // real-time quote must be valid at least for N minutes (TBD)
}
